{% extends 'base.html' %}

{% block title %}Unidad Academica{% endblock %}

{% block styles %}
<link rel="stylesheet" href="/static/css/components/header.css">
<link rel="stylesheet" href="/static/css/components/filters.css">
<link rel="stylesheet" href="/static/css/components/tables.css">
<link rel="stylesheet" href="/static/css/components/forms.css">
{% endblock %}

{% block content %}
<div class="container">
    <div class="header-usuarios">
        <h2>Domicilios</h2>
        <form action="/mod_principal" method="get">
            <button type="submit" class="btn-volver">Regresar</button>
        </form>
    </div>

    {% if rol == 'Administrador' or rol == 'Jefe/a de Departamento' or rol == 'Jefe/a de División' or rol == 'Director/a
    de DII' %}
    <div class="registro-container">
        <h3 id="titulo-usuario">Registro Unidad Académica</h3>

        <form id="registroUA">
            <div class="form-row">
                <div class="form-group">
                    <label for="sigla">Sigla</label>
                    <input type="text" id="sigla" name="sigla" required class="input-form">
                </div>

                <div class="form-group">
                    <label for="nombreUA">Nombre</label>
                    <input type="text" id="nombreUA" name="nombre" required class="input-form">
                </div>

                <div class="form-group">
                    <label for="claveUA">Clave</label>
                    <input type="text" id="claveUA" name="clave" required class="input-form">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="director">Director</label>
                    <input type="text" id="director" class="input-form">
                </div>

                <div class="form-group">
                    <label for="rama">Rama</label>
                    <select id="rama" class="input-form">
                        <option value="">Selecciona una rama</option>
                        {% for r in rama %}
                        <option value="{{ r.Id_Rama }}">{{ r.Nombre_Rama }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="form-row">

                <div class="form-group">
                    <label for="entidad">Entidad</label>
                    <select id="entidad" class="input-form">
                        <option value="">Selecciona una entidad</option>
                        {% for e in entidad | unique(attribute='Nombre_Entidad') %}
                        <option value="{{ e.Nombre_Entidad }}">{{ e.Nombre_Entidad }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="municipio">Municipio</label>
                    <select id="municipio" class="input-form" disabled>
                        <option value="">Selecciona un municipio</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="localidad">Localidad</label>
                    <select id="localidad" class="input-form" disabled>
                        <option value="">Selecciona una localidad</option>
                    </select>
                </div>

            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="calle">Calle</label>
                    <input type="text" id="calle" class="input-form">
                </div>

                <div class="form-group">
                    <label for="colonia">Colonia</label>
                    <input type="text" id="colonia" class="input-form">
                </div>

                <div class="form-group">
                    <label for="cp">C.P.</label>
                    <input type="text" id="cp" name="cp" pattern="^\d{5}$" maxlength="5" required
                        title="Debe ser un número de exactamente 5 dígitos" class="input-form" />
                </div>
            </div>

            <div class="form-row">
                <button type="submit" id="btn-guardar">Registrar</button>
                <button type="button" id="btn-cancelar">Cancelar</button>
                <button type="button" id="btn-limpiar">Limpiar</button>
                <button type="button" id="btn-eliminar" style="display:none;">Eliminar</button>
            </div>
        </form>

        <div id="mensaje"></div>
    </div>
    {% endif %}

    <div class="filtro-ua-box">
        <label for="filtro-ua">Filtrar por Unidad Académica:</label>
        <select id="filtro-ua" class="input-form">
            <option value="">Todas</option>
            {% for d in domicilios|unique(attribute='Sigla') %}
            <option value="{{ d.Sigla }}">{{ d.Sigla }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="table-container">
        <table id="tabla-domicilios">
            <thead>
                <tr>
                    <th>Sigla</th>
                    <th>Nombre</th>
                    <th>Clave</th>
                    <th>Director</th>
                    <th>Rama</th>
                    <th>Calle</th>
                    <th>Colonia</th>
                    <th>C.P.</th>
                    <th>Entidad</th>
                    <th>Municipio</th>
                    <th>Localidad</th>
                </tr>
            </thead>

            <tbody>
                {% for d in domicilios %}
                <tr class="fila-edit">
                    <td>{{ d.Sigla }}</td>
                    <td>{{ d.Nombre }}</td>
                    <td>{{ d.Clave }}</td>
                    <td>{{ d.Director }}</td>
                    <td>{{ d.Nombre_Rama }}</td>
                    <td>{{ d.Calle }}</td>
                    <td>{{ d.Colonia }}</td>
                    <td>{{ d.CP }}</td>
                    <td>{{ d.Nombre_Entidad }}</td>
                    <td>{{ d.Nombre_Municipio }}</td>
                    <td>{{ d.Nombre_Localidad }}</td>
                </tr>
                {% endfor %}
            </tbody>

        </table>
    </div>

</div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener("DOMContentLoaded", () => {

        // =====================================
        // REFERENCIAS
        // =====================================
        const form = document.getElementById("registroUA");
        const btnGuardar = document.getElementById("btn-guardar");
        const btnEliminar = document.getElementById("btn-eliminar");
        const btnCancelar = document.getElementById("btn-cancelar");
        const btnLimpiar = document.getElementById("btn-limpiar");
        const titulo = document.getElementById("titulo-usuario");

        const filas = document.querySelectorAll(".fila-edit");

        const entidadSelect = document.getElementById("entidad");
        const municipioSelect = document.getElementById("municipio");
        const localidadSelect = document.getElementById("localidad");

        // =====================================
        // VARIABLES DE CONTROL
        // =====================================
        let siglaOriginal = null;   // ✔ Aquí se almacenará la sigla anterior

        // =====================================
        // DATOS ENTIDAD
        // =====================================
        const entidadesData = [
            {% for e in entidad %}
        {
            Nombre_Entidad: "{{ e.Nombre_Entidad }}",
            Nombre_Municipio: "{{ e.Nombre_Municipio }}",
            Nombre_Localidad: "{{ e.Nombre_Localidad }}"
        },
        {% endfor %}
    ];

    // =====================================
    // DATOS RAMA
    // =====================================
    const ramasData = [
        {% for r in rama %}
    { Id_Rama: "{{ r.Id_Rama }}", Nombre_Rama: "{{ r.Nombre_Rama }}" },
    {% endfor %}
    ];

    // =====================================
    // FUNCIONES DE SELECT ANIDADO
    // =====================================
    function populateMunicipios(entidad) {
        municipioSelect.innerHTML = '<option value="">Selecciona un municipio</option>';
        localidadSelect.innerHTML = '<option value="">Selecciona una localidad</option>';
        localidadSelect.disabled = true;

        if (!entidad) {
            municipioSelect.disabled = true;
            return;
        }

        const municipios = [...new Set(
            entidadesData.filter(e => e.Nombre_Entidad === entidad)
                .map(e => e.Nombre_Municipio)
        )];

        municipios.forEach(m => {
            const opt = document.createElement("option");
            opt.value = opt.textContent = m;
            municipioSelect.appendChild(opt);
        });

        municipioSelect.disabled = false;
    }

    function populateLocalidades(entidad, municipio) {
        localidadSelect.innerHTML = '<option value="">Selecciona una localidad</option>';

        if (!municipio) {
            localidadSelect.disabled = true;
            return;
        }

        const localidades = [...new Set(
            entidadesData.filter(e => e.Nombre_Entidad === entidad &&
                e.Nombre_Municipio === municipio)
                .map(e => e.Nombre_Localidad)
        )];

        localidades.forEach(l => {
            const opt = document.createElement("option");
            opt.value = opt.textContent = l;
            localidadSelect.appendChild(opt);
        });

        localidadSelect.disabled = false;
    }

    entidadSelect.addEventListener("change", () => {
        populateMunicipios(entidadSelect.value);
    });

    municipioSelect.addEventListener("change", () => {
        populateLocalidades(entidadSelect.value, municipioSelect.value);
    });

    // =====================================
    // CARGAR INFORMACIÓN DE UNA FILA AL FORMULARIO
    // =====================================
    filas.forEach(fila => {
        fila.addEventListener("click", () => {
            const c = fila.children;

            // ✔ Guardamos la sigla original antes de modificarla
            siglaOriginal = c[0].textContent.trim();

            document.getElementById("sigla").value = siglaOriginal;
            document.getElementById("nombreUA").value = c[1].textContent.trim();
            document.getElementById("claveUA").value = c[2].textContent.trim();
            document.getElementById("director").value = c[3].textContent.trim();

            const nombreRama = c[4].textContent.trim();
            const rEncontrada = ramasData.find(r => r.Nombre_Rama === nombreRama);
            document.getElementById("rama").value = rEncontrada ? rEncontrada.Id_Rama : "";

            document.getElementById("calle").value = c[5].textContent.trim();
            document.getElementById("colonia").value = c[6].textContent.trim();
            document.getElementById("cp").value = c[7].textContent.trim();

            const entidad = c[8].textContent.trim();
            const municipio = c[9].textContent.trim();
            const localidad = c[10].textContent.trim();

            entidadSelect.value = entidad;
            populateMunicipios(entidad);

            setTimeout(() => {
                municipioSelect.value = municipio;
                populateLocalidades(entidad, municipio);

                setTimeout(() => {
                    localidadSelect.value = localidad;
                }, 150);
            }, 150);

            btnGuardar.textContent = "Actualizar";
            btnEliminar.style.display = "inline-block";
            titulo.textContent = "Editar Unidad Académica";
        });
    });

    // =====================================
    // REGISTRAR / ACTUALIZAR UA
    // =====================================
    form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const data = {
            sigla: sigla.value.trim(),
            nombre: nombreUA.value.trim(),
            clave: claveUA.value.trim(),
            director: director.value.trim(),
            rama: rama.value.trim(),
            calle: calle.value,
            colonia: colonia.value,
            cp: parseInt(cp.value) || null,
            entidad: entidadSelect.value,
            municipio: municipioSelect.value,
            localidad: localidadSelect.value
        };

        if (!data.sigla || !data.nombre || !data.clave) {
            alert("Sigla, Nombre y Clave son obligatorios.");
            return;
        }

        // ==========================
        // Registrar
        // ==========================
        if (btnGuardar.textContent === "Registrar") {

            const res = await fetch("/registrarUA", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });

            const r = await res.json();
            alert(r.msg || "Registrado correctamente");

            // ==========================
            // Actualizar
            // ==========================
        } else {

            data.sigla_anterior = siglaOriginal;   // ✔ Mandamos la sigla original
            data.sigla = document.getElementById("sigla").value.trim(); // nueva sigla

            const res = await fetch(`/actualizarUA/`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });

            const r = await res.json();
            alert(r.msg || "Actualizado correctamente");
        }

        location.reload();
    });

    // =====================================
    // ELIMINAR
    // =====================================
    btnEliminar.addEventListener("click", async () => {
        const sigla = document.getElementById("sigla").value;

        if (!sigla) return alert("No hay una unidad seleccionada.");
        if (!confirm(`¿Eliminar la unidad "${sigla}"?`)) return;

        const res = await fetch(`/eliminarUA/${sigla}`, {
            method: "DELETE"
        });

        const r = await res.json();
        alert(r.msg || "Eliminado correctamente");

        location.reload();
    });

    // =====================================
    // LIMPIAR / CANCELAR
    // =====================================
    btnLimpiar.addEventListener("click", () => {
        form.reset();
        btnGuardar.textContent = "Registrar";
        btnEliminar.style.display = "none";
        titulo.textContent = "Registro Unidad Académica";
        siglaOriginal = null;
    });

    btnCancelar.addEventListener("click", () => {
        form.reset();
        btnGuardar.textContent = "Registrar";
        btnEliminar.style.display = "none";
        titulo.textContent = "Registro Unidad Académica";
        siglaOriginal = null;
    });

});
</script>

{% endblock %}