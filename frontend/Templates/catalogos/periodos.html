{% extends 'base.html' %}

{% block title %}Periodos{% endblock %}

{% block styles %}
<link rel="stylesheet" href="/static/css/components/header.css">
<link rel="stylesheet" href="/static/css/components/forms.css">
<link rel="stylesheet" href="/static/css/components/filters.css">
<link rel="stylesheet" href="/static/css/components/tables.css">
<link rel="stylesheet" href="/static/css/components/modal.css">

{% endblock %}

{% block content %}
<div class="container">
    <div class="header-usuarios">
        <h2>Cat√°logo de Periodos</h2>
        <form action="/mod_principal" method="get">
            <button type="submit" class="btn-volver">Regresar</button>
        </form>
    </div>



    <!-- Formulario de registro/edici√≥n de usuarios -->
    {% if rol == 'Administrador' or rol == 'Jefe/a de Departamento' or rol == 'Jefe/a de Divisi√≥n' or rol == 'Director/a
    de DII' %}
    <div class="registro-container">
        <h3 id="titulo-usuario">Registro Periodo</h3>
        <form id="registroP">
            <div class="form-row">

                <div class="form-group">
                    <label for="perido">Periodo</label>
                    <input type="text" id="periodo" name="periodo" placeholder="Periodo" required class="input-form">
                </div>
                <div class="form-row">
                    <button type="submit" id="btn-guardar">Registrar Nuevo Periodo</button>
                </div>
            </div>

        </form>
        <div id="mensaje"></div>
    </div>
    {% endif %}



    <!-- üîπ Filtro por Activos/Inactivos -->
    <div class="filtro-ua-box">
        <label for="filtro-periodo">Filtrar por Estado:</label>
        <select id="filtro-periodo" class="input-form">
            <option value="">Todos (Activos e Inactivos)</option>
            {% for d in periodos|unique(attribute='Descripcion') %}
            <option value="{{ d.Descripcion }}">{{ d.Descripcion }}</option>
            {% endfor %}
        </select>
    </div>


    <!-- üîπ Tabla de periodos -->
    <div class="table-container">
        <table id="tabla-periodos">
            <thead>
                <tr>
                    <th>Periodo</th>
                    <th>Descripci√≥n</th>
                </tr>
            </thead>
            <tbody>
                {% for d in periodos %}
                <tr class="fila-edit">
                    <td>{{ d.Periodo }}</td>
                    <td>{{ d.Descripcion }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}


<!-- Script que sirve para el filtro por periodos -->
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const filtro = document.getElementById("filtro-periodo");
        const filas = document.querySelectorAll("#tabla-periodos tbody tr");

        filtro.addEventListener("change", () => {
            const valor = filtro.value.toLowerCase().trim();

            filas.forEach(fila => {
                // Cambiado: ahora filtra por la columna 1 (Descripci√≥n)
                const estado = fila.cells[1].textContent.toLowerCase().trim();

                // Mostrar todas si no hay filtro o si coincide exactamente
                if (valor === "" || estado === valor) {
                    fila.style.display = "";
                } else {
                    fila.style.display = "none";
                }
            });
        });
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", () => {

        // üîπ TOMAR EL √öLTIMO PERIODO QUE LLEGA DESDE PYTHON (periodos[0] deber√≠a ser el m√°s reciente)
        {% if periodos %}
        const ultimoPeriodo = "{{ periodos[0].Periodo }}";  // Ejemplo: "2022-2023/2"
        {% else %}
        const ultimoPeriodo = null;
        {% endif %}

        const inputPeriodo = document.getElementById("periodo");

        if (ultimoPeriodo) {
            const siguiente = calcularSiguientePeriodo(ultimoPeriodo);
            inputPeriodo.value = siguiente;
        }

        // üîπ Funci√≥n para calcular el periodo siguiente
        function calcularSiguientePeriodo(periodoActual) {
            // periodoActual ejemplo: "2022-2023/2"
            const [anos, numero] = periodoActual.split("/");
            const [a1, a2] = anos.split("-").map(n => parseInt(n.trim()));
            const n = parseInt(numero.trim());

            let nuevoA1 = a1;
            let nuevoA2 = a2;
            let nuevoN = n;

            if (n === 1) {
                nuevoN = 2;
            } else if (n === 2) {
                nuevoA1 = a1 + 1;
                nuevoA2 = a2 + 1;
                nuevoN = 1;
            }

            return `${nuevoA1}-${nuevoA2}/${nuevoN}`;
        }

        // üîπ Al registrar nuevo periodo ‚Üí llamada a FastAPI
        document.getElementById("registroP").addEventListener("submit", async (e) => {
            e.preventDefault();

            const periodo = inputPeriodo.value;

            const respuesta = await fetch("/nuevo_periodo", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ periodo })
            });

            const data = await respuesta.json();

            const divMensaje = document.getElementById("mensaje");

            if (data.success) {
                divMensaje.innerHTML = `<span style="color:green">Periodo registrado: ${periodo}</span>`;
            } else {
                divMensaje.innerHTML = `<span style="color:red">${data.error}</span>`;
            }
        });

    });
</script>



{% endblock %}